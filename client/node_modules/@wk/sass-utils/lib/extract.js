'use strict'

let fs = require('fs');
let path = require('path');
let pify = require('pify');
let read = pify(fs.readFile);
let write = pify(fs.writeFile);
let mkdir = pify(require('mkdirp'));
let dirname = path.dirname;
let basename = path.basename;
let vars = require('get-sass-vars');
// removes comments
let clean = str => str
    .split('\n')
    .filter(x => x[0] !== '/')
    .join('\n');

module.exports = function extract(file, dest, deps, camelize) {
    let tpl = `@import '%lib';`;
    let includes = deps.map(dep => dirname(dep));
    let template = deps.map(dep => tpl.replace('%lib', basename(dep))).join('\n');
    let options = {
        camelize: camelize,
        sassOptions: {
            includePaths: includes
        }
    };

    return read(file, { encoding: 'utf8' })
            .then(src => template.concat('\n', clean(src)))
            .then(src => vars(src, options))
            .then(json => mkdir(dirname(dest)).then(() => json))
            .then(json => write(dest, JSON.stringify(json, null, 4)));
}
